services:
  edulution-moodle-db:
    container_name: edulution-moodle-db
    image: mariadb:10.11
    restart: unless-stopped
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
    environment:
      MARIADB_USER: moodle
      MARIADB_PASSWORD: ${MOODLE_DB_PASSWORD}
      MARIADB_DATABASE: moodle
      MARIADB_ROOT_PASSWORD: ${MOODLE_DB_ROOT_PASSWORD}
    volumes:
      - /srv/docker/edulution-moodle/db-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect"]
      interval: 10s
      timeout: 5s
      retries: 3

  edulution-moodle-app:
    container_name: edulution-moodle-app
    image: ghcr.io/edulution-io/edulution-moodle:latest
    restart: unless-stopped
    depends_on:
      - edulution-moodle-db
    environment:
      # DATENBANK
      MOODLE_DATABASE_HOST: edulution-moodle-db
      MOODLE_DATABASE_NAME: moodle
      MOODLE_DATABASE_USER: moodle
      MOODLE_DATABASE_PASSWORD: ${MOODLE_DB_PASSWORD}
      # MOODLE GRUNDEINSTELLUNGEN
      MOODLE_WWWROOT: <MOODLE_WWWROOT>
      MOODLE_ADMIN_USER: admin
      MOODLE_ADMIN_PASSWORD: ${MOODLE_ADMIN_PASSWORD}
      MOODLE_ADMIN_EMAIL: <MOODLE_ADMIN_EMAIL>
      MOODLE_SITE_NAME: <MOODLE_SITE_NAME>
      # REVERSE PROXY / TRAEFIK
      MOODLE_REVERSEPROXY: "false"
      MOODLE_SSLPROXY: "true"
      MOODLE_ALLOWFRAMEMBEDDING: "true"
      # EDULUTION PLUGIN - KEYCLOAK
      EDULUTION_KEYCLOAK_URL: ${KEYCLOAK_API}
      EDULUTION_KEYCLOAK_REALM: ${KEYCLOAK_EDU_UI_REALM}
      EDULUTION_KEYCLOAK_CLIENT_ID: ${KEYCLOAK_MOODLE_CLIENT_ID}
      EDULUTION_KEYCLOAK_CLIENT_SECRET: ${KEYCLOAK_MOODLE_CLIENT_SECRET}
      EDULUTION_KEYCLOAK_SYNC_ENABLED: "true"
      EDULUTION_VERIFY_SSL: "true"
    volumes:
      - /srv/docker/edulution-moodle/moodledata:/var/moodledata
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -fs http://localhost/moodle-app/login/index.php || exit 1",
        ]
      interval: 60s
      timeout: 10s
      start_period: 180s
      retries: 3
